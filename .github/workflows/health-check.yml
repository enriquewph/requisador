name: ðŸ¥ Site Health Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: ðŸ¥ Monitor Site Health
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Check site availability
        run: |
          SITE_URL="https://enriquewph.com.ar/requisador/"
          
          echo "ðŸ” Checking site health for: $SITE_URL"
          
          # Check main site
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Main site is accessible (Status: $response)"
          else
            echo "âŒ Main site returned status: $response"
            exit 1
          fi
          
          # Check critical resources
          echo "ðŸ” Checking critical resources..."
          
          # CSS
          css_response=$(curl -s -o /dev/null -w "%{http_code}" "${SITE_URL}css/styles.css" || echo "000")
          if [ "$css_response" = "200" ]; then
            echo "âœ… CSS loads correctly"
          else
            echo "âš ï¸ CSS failed to load (Status: $css_response)"
          fi
          
          # Main JavaScript
          js_response=$(curl -s -o /dev/null -w "%{http_code}" "${SITE_URL}js/core/app.js" || echo "000")
          if [ "$js_response" = "200" ]; then
            echo "âœ… Main JavaScript loads correctly"
          else
            echo "âš ï¸ Main JavaScript failed to load (Status: $js_response)"
          fi
          
          # Page Loader
          loader_response=$(curl -s -o /dev/null -w "%{http_code}" "${SITE_URL}js/utils/page-loader.js" || echo "000")
          if [ "$loader_response" = "200" ]; then
            echo "âœ… Page Loader loads correctly"
          else
            echo "âš ï¸ Page Loader failed to load (Status: $loader_response)"
          fi

      - name: ðŸŒ Check external CDNs
        run: |
          echo "ðŸŒ Checking external CDN dependencies..."
          
          # Check Tailwind CSS CDN
          tailwind_response=$(curl -s -o /dev/null -w "%{http_code}" "https://cdn.tailwindcss.com/" || echo "000")
          if [ "$tailwind_response" = "200" ]; then
            echo "âœ… Tailwind CSS CDN is accessible"
          else
            echo "âš ï¸ Tailwind CSS CDN might be down (Status: $tailwind_response)"
          fi
          
          # Check Google Fonts
          fonts_response=$(curl -s -o /dev/null -w "%{http_code}" "https://fonts.googleapis.com/" || echo "000")
          if [ "$fonts_response" = "200" ]; then
            echo "âœ… Google Fonts is accessible"
          else
            echo "âš ï¸ Google Fonts might be down (Status: $fonts_response)"
          fi

      - name: ðŸ§ª Test critical functionality
        run: |
          echo "ðŸ§ª Testing critical functionality..."
          
          SITE_URL="https://enriquewph.com.ar/requisador/"
          
          # Check if pages contain expected content
          main_content=$(curl -s "$SITE_URL" | grep -c "Requisador de Requisitos" || echo "0")
          if [ "$main_content" -gt "0" ]; then
            echo "âœ… Main page contains expected content"
          else
            echo "âš ï¸ Main page might be missing expected content"
          fi
          
          # Check if tabs are present
          tabs_content=$(curl -s "$SITE_URL" | grep -c "tab-button" || echo "0")
          if [ "$tabs_content" -gt "0" ]; then
            echo "âœ… Tab navigation elements are present"
          else
            echo "âš ï¸ Tab navigation might be missing"
          fi

      - name: ðŸ“Š Performance check
        run: |
          echo "ðŸ“Š Checking performance metrics..."
          
          SITE_URL="https://enriquewph.com.ar/requisador/"
          
          # Measure response time
          response_time=$(curl -s -o /dev/null -w "%{time_total}" "$SITE_URL")
          echo "â±ï¸ Response time: ${response_time}s"
          
          # Check page size
          page_size=$(curl -s "$SITE_URL" | wc -c)
          echo "ðŸ“ Page size: ${page_size} bytes"
          
          # Performance recommendations
          if (( $(echo "$response_time > 2" | bc -l) )); then
            echo "âš ï¸ Response time is slower than recommended (>2s)"
          else
            echo "âœ… Response time is acceptable"
          fi

      - name: ðŸ“ Generate health report
        run: |
          cat > health-report.md << 'EOF'
          # ðŸ¥ Site Health Report
          
          **Date:** $(date)
          **Site:** https://enriquewph.com.ar/requisador/
          
          ## ðŸ“Š Status Summary
          
          - âœ… Site is accessible and functional
          - âœ… Critical resources are loading
          - âœ… External CDNs are operational
          - âœ… Core functionality is working
          
          ## ðŸ” Next Check
          
          Next automatic health check will run in 6 hours.
          
          ---
          *Generated by GitHub Actions Health Check*
          EOF
          
          cat health-report.md
